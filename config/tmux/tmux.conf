#g https://github.com/tmux/tmux/wiki/Modifier-Keys
# NOTE: rename window - prefix ,
# NOTE: rename session - prefix $
# https://en.wikipedia.org/wiki/Control_character#In_ASCII
# Control characters not allowed
# ^G ^H ^I ^J ^K ^L ^M
unbind C-b
set -g prefix C-a # prefix

# udemy
bind-key -r u run-shell "tmux-sessionizer ~/src/udemy/schwarz/next.js"
# top row for personal projects
bind-key -r G run-shell "tmux-sessionizer ~/src/me/timtoggl/timtoggl"
bind-key -r C run-shell "tmux-sessionizer ~/src/me/toggl-cli"
bind-key -r R run-shell "tmux-sessionizer ~/src/clones/Allaman/nvim"
bind-key -r L run-shell "tmux-sessionizer ~/src/clones"
bind-key -r S run-shell "tmux-sessionizer ~/dotfiles"
# top row for personal projects
bind-key -r H run-shell "tmux-sessionizer ~/src/candy/referralcandy-main"
bind-key -r T run-shell "tmux-sessionizer ~/src/candy/candymold"
# rc main
bind-key -r M run-shell "tmux-sessionizer ~/src/candy/referralcandy-main/packages/frontend"
bind-key -r W run-shell "tmux-sessionizer ~/src/candy/referralcandy-main/packages/api"

set -g renumber-windows on # renumber windows as they are created and destroyed to keep them consistent with the count
set -g base-index 1 # Start index of window/pane with 1, because we're humans, not computers
setw -g pane-base-index 1 
setw -g mode-keys vi # Use vim keybindings in copy mode
set -s escape-time 0 # address vim mode switching delay (http://superuser.com/a/252717/65504)
set -g history-limit 50000 # increase scrollback buffer size
set -g default-terminal "screen-256color"
set -g status-keys emacs # emacs key bindings in tmux command prompt (better than vi)

# quick pane examples - send command to a pane
bind-key h split-window -h "top"
bind-key e split-window -h "nvim ~/.config/nvim/init.lua"

# reload config
bind-key r source-file $XDG_CONFIG_HOME/tmux/tmux.conf \; display-message "~/.tmux.conf reloaded" # reload config file manually

# l - last session
# n - next session
# s - break out pane to new session
# k - kill session

# c - new window
# b - break out pane to new window in session
# g - previous window
# r - next window
# w - kill window

# h - new horizontal pane
# t - new vertical pane
# d - destroy pane

bind -n C-M-l switch-client -l # go to last client
bind -n C-M-n switch-client -n # go to next client

# create
bind -n C-M-c new-window -c "#{pane_current_path}" # open new window with current pane's directory (instead of using the session's dir)
bind-key -n C-M-b break-pane -d # break a pane out to a new window so that its process can continue
bind-key -n C-M-s send-keys 'tat && exit' 'C-m' # C-m is the enter key - break out pane to new session
bind-key -n M-C-h split-window -v  -c '#{pane_current_path}'
bind-key -n C-M-t split-window -h  -c '#{pane_current_path}'
# kill 
bind-key -n C-M-k run-shell 'tmux switch-client -n \; kill-session -t "$(tmux display-message -p "#S")" || tmux kill-session' # kill session but don't kick us out of tmux
bind -n C-M-w kill-window # TODO: how to kill the last window in session but not leave tmux?
bind-key -n C-M-d kill-pane # TODO: how to kill the last pane without leaving tmux?

# ??
bind C-j split-window -v "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t" # dunno what this does
bind-key j command-prompt -p "join pane from: "  "join-pane -h -s '%%'" # join pane ?

# Windows
bind-key -n C-M-S-g swap-window -t -1 \; previous-window # move window to the left
bind-key -n C-M-S-r swap-window -t +1 \; next-window # move window to the right
bind-key -n C-M-g previous-window
bind-key -n C-M-r next-window

# Panes 
bind-key C-a run "tmux split-window -p 40 'zsh -ci fzf_tmux_switch_session'"
## info
bind-key s display-panes\; command-prompt -p "pane #: "  "swap-pane -t '%%'" # swap pane with current pane ?

# Works with https://github.com/alexghergh/nvim-tmux-navigation
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'M-h' if-shell "$is_vim" 'send-keys M-h' 'select-pane -L'
bind-key -n 'M-t' if-shell "$is_vim" 'send-keys M-t' 'select-pane -D'
bind-key -n 'M-n' if-shell "$is_vim" 'send-keys M-n' 'select-pane -U'
bind-key -n 'M-s' if-shell "$is_vim" 'send-keys M-s' 'select-pane -R'
bind-key -n 'M--' if-shell "$is_vim" 'send-keys M--' 'select-pane -l'
bind-key -n 'M-Enter' if-shell "$is_vim" 'send-keys M-Enter' 'select-pane -t:.+'

# resize panes
bind -n C-M-z resize-pane -Z
bind -n S-Left resize-pane -L 2
bind -n S-Right resize-pane -R 2
bind -n S-Down resize-pane -D 1
bind -n S-Up resize-pane -U 1
bind -n C-Left resize-pane -L 10
bind -n C-Right resize-pane -R 10
bind -n C-Down resize-pane -D 5
bind -n C-Up resize-pane -U 5

# tpm plugins
# Shortcuts - I, U and A-U
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'dracula/tmux'
set -g @plugin 'fcsonline/tmux-thumbs'
# set -g @plugin 'tmux-plugins/tmux-sensible'

# dracula
set -g @dracula-plugins "git"
set -g @dracula-show-left-icon session # show session name in status bar
set -g @dracula-border-contrast true
set -g @dracula-refresh-rate 5

# tmux thumbs
set -g @thumbs-command 'echo -n {} | pbcopy' # use os clipboard instead of tmux buffers
set -g @thumbs-alphabet dvorak-homerow
# set -g @thumbs-regexp-1 '[a-z]+@[a-z]+.com' # Match emails

set-environment -g TMUX_PLUGIN_MANAGER_PATH "$XDG_DATA_HOME/tmux/plugins/"
run '$XDG_DATA_HOME/tmux/plugins/tpm/tpm'
